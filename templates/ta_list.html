{% extends 'base.html' %}
{% load static  %}
{% block link %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/vending_cards.css' %}">
{% endblock %}
{% block content %}
<h2>–¢–æ—Ä–≥–æ–≤—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã</h2>
<div class="ta-filters">
  <form method="get" style="display: flex; justify-content: space-between;">
    {% csrf_token %}
    <div class="">
      –ü–æ–∫–∞–∑–∞—Ç—å {{filter.count_ta}} –∑–∞–ø–∏—Å–µ–π
    </div>
    <div class="">
      {{filter.search}}
    </div>
    <div class="" style="display: flex; justify-content: center;">
      <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
  </form>
</div>
{% if page_obj.paginator.count == 0 %}
  <p>–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ: –æ—Ñ–æ—Ä–º–∏—Ç–µ –¢–ê –≤ –∞—Ä–µ–Ω–¥—É (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è)</p>
{% endif %}
<table class="ta-table">
  <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ú–æ–¥–µ–ª—å</th><th>–ö–æ–º–ø–∞–Ω–∏—è</th><th>–ú–æ–¥–µ–º</th><th>–ê–¥—Ä–µ—Å</th><th>–í —Ä–∞–±–æ—Ç–µ —Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
  <tbody>
  {% for m in page_obj %}
    <tr class="{% cycle 'odd' 'even' %}">
      <td>{{ m.machine.id_code }}</td>
      <td>{{ m.machine.name }}</td>
      <td>{{ m.machine.model }}</td>
      <td>{{ m.machine.company.name }}</td>
      <td>{{ m.machine.modem }}</td>
      <td>{{ m.machine.address }}</td>
      <td>{{ m.start_date }}</td>
      <td>
        <a href="{% url 'ta_edit' m.machine.pk %}">üñãÔ∏è</a> 
        <a href="{% url 'ta_delete' m.machine.pk %}">üóëÔ∏è</a> 
        <a href="{% url 'ta_unlink_modem' m.machine.pk %}">üîì</a>
      </td>
    </tr>
  {% empty %}
    <tr><td colspan="7">–í —Ç–∞–±–ª–∏—Ü–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ</td></tr>
  {% endfor %}
  </tbody>
</table>
<div class="" style="display: flex; justify-content: space-between;">
  <div class="pagination">
    <span class="step-links">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.count_ta %}&count_ta={{ request.GET.count_ta }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">–ø—Ä–µ–¥—ã–¥—É—â–∞—è</a>
      {% endif %}

      <span class="current">
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
      </span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.count_ta %}&count_ta={{ request.GET.count_ta }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">—Å–ª–µ–¥—É—é—â–∞—è</a>
      {% endif %}
    </span>
  </div>
  <div class="ta-export" style="margin-top: 10px;">
    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#machineSelectionModal">–î–æ–±–∞–≤–∏—Ç—å</button>
    <!-- Modal -->
    <div class="modal fade" id="machineSelectionModal" tabindex="-1" aria-labelledby="machineSelectionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-md">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="machineSelectionModalLabel">–í—ã–±–æ—Ä —Ç–æ—Ä–≥–æ–≤—ã—Ö –∞–ø–ø–∞—Ä–∞—Ç–æ–≤</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- –°–µ–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
            <div class="filter-section">
              <div class="row">
                  <div class="col-md-6">
                      <div class="mb-3">
                          <label for="searchInput" class="form-label">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ID</label>
                          <input type="text" class="form-control" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
                      </div>
                  </div>
                  <div class="col-md-6">
                      <div class="mb-3">
                          <label for="availabilityFilter" class="form-label">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</label>
                          <select class="form-select" id="availabilityFilter">
                              <option value="all">–í—Å–µ</option>
                              <option value="available">–î–æ—Å—Ç—É–ø–µ–Ω</option>
                              <option value="unavailable">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</option>
                          </select>
                      </div>
                  </div>
              </div>
            </div>
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ -->
            <div id="machines-container" class="mt-3">
              {% for machine in machines %}
                <div class="card" id="card-machine">
                  <div class="vending-image">
                    <i class="bi bi-cup-hot-fill" style="font-size: 3rem;"></i>
                  </div>
                    
                  {% if machine.is_available %}
                    <!-- –ë–µ–π–¥–∂ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ -->
                    <span class="status-badge bg-success">–î–æ—Å—Ç—É–ø–µ–Ω</span>
                  {% else %}
                    <span class="status-badge bg-danger">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω</span>
                  {% endif %}
                  <div class="card-header">
                      <h5 class="card-title mb-0 machine-name">{{machine.name}}</h5>
                      <p class="text-muted mb-0 machine-id">{{machine.id_code}}</p>
                  </div>

                  <div class="card-body">
                    <div class="d-flex mb-3">
                        <div class="icon-wrapper bg-primary">
                            <i class="bi bi-building text-white"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">{{machine.company.name}}</h6>
                            <small class="text-muted">–í–ª–∞–¥–µ–ª–µ—Ü</small>
                        </div>
                    </div>
                      
                    <div class="d-flex mb-3">
                        <div class="icon-wrapper bg-info">
                            <i class="bi bi-geo-alt text-white"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">{{machine.company.address}}</h6>
                            <small class="text-muted">–ê–¥—Ä–µ—Å</small>
                        </div>
                    </div>
                      
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">–ú–æ–¥–µ–ª—å:</small>
                            <p class="mb-0">{{machine.model}}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">–ú–æ–¥–µ–º:</small>
                            <p class="mb-0">{{machine.modem}}</p>
                        </div>
                    </div>
                      
                    <div class="mb-3">
                        <small class="text-muted">–í —Ä–∞–±–æ—Ç–µ —Å:</small>
                        <p class="mb-0">{{machine.in_work_since}}</p>
                    </div>
                      
                    <hr>
                      
                    <div class="financial-info">
                      <h6 class="mb-3">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                      <div class="d-flex justify-content-between mb-2">
                        <span>–û–±—â–∏–π –¥–æ—Ö–æ–¥:</span>
                        <strong>{{machine.total_income}} ‚ÇΩ</strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>–ê—Ä–µ–Ω–¥–∞ –≤ –º–µ—Å—è—Ü:</span>
                        <strong>{{machine.monthly_rent}} ‚ÇΩ</strong>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span>–ê—Ä–µ–Ω–¥–∞ –≤ –≥–æ–¥:</span>
                        <strong>{{machine.yearly_rent}} ‚ÇΩ</strong>
                      </div>
                      <div class="d-flex justify-content-between">
                        <span>–°—Ä–æ–∫ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:</span>
                        <strong>{{machine.payback_period}} –º–µ—Å</strong>
                      </div>
                    </div>
                  </div>
                  <div class="">
                    <a href="{% url 'booking_page' machine.id %}" class="btn btn-primary w-100 {% if not machine.is_available %}disabled{% endif %}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é</a>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <a href="{% url 'ta_export' %}?{% if request.GET.search %}search={{ request.GET.search }}{% endif %}" class="btn btn-primary">
        –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    </a>
  </div>
</div>

{% endblock %}

{% block scripts %}

  <script>
    const availabilityFilter = document.getElementById("availabilityFilter");
    const searchInput = document.getElementById("searchInput");
    const cardContainer = document.querySelectorAll("#card-machine");


    function checkFilters() {
      cardContainer.forEach(element => {
      const status = element.getElementsByClassName("status-badge").item(0).textContent
      const machineName = element.getElementsByClassName("machine-name").item(0).textContent
      const machineId = element.getElementsByClassName("machine-id").item(0).textContent

      if (availabilityFilter.value === "available" && status !== "–î–æ—Å—Ç—É–ø–µ–Ω") {
        element.style.display = "none";
      } else if (availabilityFilter.value === "unavailable" && status !== "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω") {
        element.style.display = "none";
      } else if (searchInput.value && !machineName.toLowerCase().includes(searchInput.value.toLowerCase()) && !machineId.toLowerCase().includes(searchInput.value.toLowerCase())) {
        element.style.display = "none";
      } else {
        element.style.display = "block";
      }
    });
    }

    availabilityFilter.addEventListener("change", function() {
      checkFilters();
    });

    searchInput.addEventListener("input", function() {
      checkFilters();
    });
  </script>

{% endblock %}